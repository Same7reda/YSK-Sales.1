<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ | YSK Sales</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”‘</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.0/firebase-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.0/firebase-database.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>
    <script type="text/babel" data-presets="react,typescript" data-type="module">
      import React, { useState, useEffect, useMemo, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- Global Declarations ---
      declare var firebase: any;

      // --- Types ---
      interface ActivationKey {
          code: string;
          client: { name: string; phone: string; notes: string; };
          durationDays: number;
          status: 'unused' | 'activated' | 'expired';
          createdAt: number;
          deviceId: string | null;
          activatedAt: number | null;
          expiresAt: number | null;
      }
      type FirebaseConfig = { apiKey: string; authDomain: string; databaseURL: string; projectId: string; storageBucket: string; messagingSenderId: string; appId: string; measurementId?: string };
      type ToastMessage = { id: number; message: string; type: 'success' | 'error' | 'info' };

      // --- Helper Functions ---
      const formatDate = (timestamp: number | null) => timestamp ? new Date(timestamp).toLocaleString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-';

      // --- Icons ---
      const CheckCircleIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
      const AlertTriangleIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
      const InfoIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>;
      const CopyIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>;
      const Trash2Icon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
      const RotateCcwIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;

      // --- Components ---
      function Toast({ message, onDismiss }: { message: ToastMessage, onDismiss: () => void }) {
          useEffect(() => { const timer = setTimeout(onDismiss, 4000); return () => clearTimeout(timer); }, [onDismiss]);
          const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
          const Icon = { success: CheckCircleIcon, error: AlertTriangleIcon, info: InfoIcon }[message.type];
          return (<div className={`fixed bottom-5 right-5 w-auto max-w-sm p-4 rounded-lg shadow-2xl flex items-center gap-4 text-white z-50 animate-fade-in-up ${colors[message.type]}`}><Icon className="w-6 h-6 flex-shrink-0" /><p className="font-semibold">{message.message}</p></div>);
      };

      function Dashboard({ firebaseConfig }: { firebaseConfig: FirebaseConfig }) {
          const [keys, setKeys] = useState<ActivationKey[]>([]);
          const [loading, setLoading] = useState(true);
          const [toast, setToast] = useState<ToastMessage | null>(null);
          const [newClientData, setNewClientData] = useState({ clientName: '', clientPhone: '', durationDays: 30, clientNotes: '' });
          const [isCreating, setIsCreating] = useState(false);
          const [filter, setFilter] = useState('all');
          
          const showToast = useCallback((message: string, type: ToastMessage['type']) => {
              setToast({ id: Date.now(), message, type });
          }, []);

          useEffect(() => {
              try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
              const db = firebase.database();
              const keysRef = db.ref('activation_keys');
              const listener = keysRef.on('value', (snapshot: any) => {
                  const data = snapshot.val();
                  const keyList: ActivationKey[] = data ? Object.values(data) : [];
                  // Check expiry status on load
                  const now = Date.now();
                  const updatedList = keyList.map(k => {
                      if (k.status === 'activated' && k.expiresAt && now > k.expiresAt) {
                          k.status = 'expired';
                      }
                      return k;
                  });
                  setKeys(updatedList);
                  setLoading(false);
              });
              return () => keysRef.off('value', listener);
          }, [firebaseConfig]);

          const handleCreateKey = async () => {
              const { clientName, clientPhone, durationDays, clientNotes } = newClientData;
              if (!durationDays || Number(durationDays) <= 0) {
                  showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¯Ø© ØµÙ„Ø§Ø­ÙŠØ© ØµØ§Ù„Ø­Ø© Ø¨Ø§Ù„Ø£ÙŠØ§Ù….', 'error');
                  return;
              }

              setIsCreating(true);
              const newKey = `YSK-${Date.now()}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`;
              const keyData: Omit<ActivationKey, 'createdAt'> & { createdAt: object } = {
                  code: newKey,
                  client: { name: clientName, phone: clientPhone, notes: clientNotes },
                  durationDays: Number(durationDays),
                  status: 'unused',
                  createdAt: firebase.database.ServerValue.TIMESTAMP,
                  deviceId: null,
                  activatedAt: null,
                  expiresAt: null,
              };

              try {
                  await firebase.database().ref('activation_keys/' + newKey).set(keyData);
                  navigator.clipboard.writeText(newKey);
                  showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ ÙˆÙ†Ø³Ø®Ù‡ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                  setNewClientData({ clientName: '', clientPhone: '', durationDays: 30, clientNotes: '' });
              } catch (error) {
                  console.error("Failed to create key:", error);
                  showToast('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Firebase.', 'error');
              } finally {
                  setIsCreating(false);
              }
          };
          
          const handleDeleteKey = (code: string) => { if (window.confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ ${code}ØŸ`)) { firebase.database().ref('activation_keys/' + code).remove().then(() => showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯', 'success')).catch(() => showToast('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error')); }};
          const handleResetKey = (code: string) => { if (window.confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙˆØ¯ ${code}ØŸ Ø³ÙŠØµØ¨Ø­ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯.`)) { firebase.database().ref('activation_keys/' + code).update({ status: 'unused', deviceId: null, activatedAt: null, expiresAt: null }).then(() => showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙˆØ¯', 'success')).catch(() => showToast('ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†', 'error')); } };
          const handleCopy = (text: string) => { navigator.clipboard.writeText(text); showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'info'); };

          const filteredKeys = useMemo(() => keys.filter(k => filter === 'all' || k.status === filter).sort((a,b) => b.createdAt - a.createdAt), [keys, filter]);
          const statusMap: Record<ActivationKey['status'], string> = { unused: 'ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…', activated: 'Ù†Ø´Ø·', expired: 'Ù…Ù†ØªÙ‡ÙŠ' };
          const statusColors: Record<ActivationKey['status'], string> = { unused: 'bg-gray-200 text-gray-800', activated: 'bg-green-200 text-green-800', expired: 'bg-red-200 text-red-800' };

          return (<div className="min-h-screen bg-gray-50"><header className="bg-white shadow-sm p-4 flex justify-between items-center"><h1 className="text-2xl font-bold text-blue-600">Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</h1></header><main className="p-6 space-y-6"><div className="bg-white p-6 rounded-lg shadow-md border border-gray-200"><h2 className="text-xl font-bold mb-4">Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h2><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end"><input value={newClientData.clientName} onChange={e => setNewClientData(d => ({ ...d, clientName: e.target.value }))} placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" className="p-2 border rounded-md" /><input value={newClientData.clientPhone} onChange={e => setNewClientData(d => ({ ...d, clientPhone: e.target.value }))} placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" className="p-2 border rounded-md" /><input type="number" value={newClientData.durationDays} onChange={e => setNewClientData(d => ({ ...d, durationDays: +e.target.value }))} placeholder="Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø£ÙŠØ§Ù…)" className="p-2 border rounded-md" min="1" /><button onClick={handleCreateKey} disabled={isCreating} className="w-full py-2 bg-blue-600 text-white rounded-md font-bold hover:bg-blue-700 disabled:bg-blue-300">{isCreating ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...' : 'Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙ†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯'}</button></div></div><div className="bg-white p-6 rounded-lg shadow-md border border-gray-200"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ({filteredKeys.length})</h2><div><select value={filter} onChange={e => setFilter(e.target.value)} className="p-2 border rounded-md"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="unused">ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…</option><option value="activated">Ù†Ø´Ø·</option><option value="expired">Ù…Ù†ØªÙ‡ÙŠ</option></select></div></div><div className="overflow-x-auto"><table className="w-full text-center"><thead><tr className="border-b-2"><th className="p-3">Ø§Ù„ÙƒÙˆØ¯</th><th className="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th className="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th><th className="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ¹ÙŠÙ„</th><th className="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th className="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th><th className="p-3">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>{loading ? <tr><td colSpan={7} className="p-8 text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr> : filteredKeys.map(key => (<tr key={key.code} className="border-b hover:bg-gray-50"><td className="p-3 font-mono text-sm">{key.code}</td><td className="p-3">{key.client.name || '-'}</td><td className="p-3 text-sm">{formatDate(key.createdAt)}</td><td className="p-3 text-sm">{formatDate(key.activatedAt)}</td><td className="p-3 text-sm">{formatDate(key.expiresAt)}</td><td className="p-3"><span className={`px-3 py-1 text-xs font-semibold rounded-full ${statusColors[key.status]}`}>{statusMap[key.status]}</span></td><td className="p-3"><div className="flex justify-center items-center gap-2"><button onClick={() => handleCopy(key.code)} title="Ù†Ø³Ø®"><CopyIcon className="w-5 h-5 text-gray-500 hover:text-blue-600"/></button><button onClick={() => handleResetKey(key.code)} title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†"><RotateCcwIcon className="w-5 h-5 text-gray-500 hover:text-green-600"/></button><button onClick={() => handleDeleteKey(key.code)} title="Ø­Ø°Ù"><Trash2Icon className="w-5 h-5 text-gray-500 hover:text-red-600"/></button></div></td></tr>))}</tbody></table></div></div></main>{toast && <Toast message={toast} onDismiss={() => setToast(null)} />}</div>);
      };

      const firebaseConfig: FirebaseConfig = {
        apiKey: "AIzaSyCfyM5MDpcS33KqtKVT7U7AFnmflSB0tU0",
        authDomain: "ysk-active-64860.firebaseapp.com",
        databaseURL: "https://ysk-active-64860-default-rtdb.firebaseio.com/",
        projectId: "ysk-active-64860",
        storageBucket: "ysk-active-64860.firebasestorage.app",
        messagingSenderId: "592299818494",
        appId: "1:592299818494:web:6710d728a4f8e5e041d4af",
        measurementId: "G-FL7VH6S4JM"
      };

      const App: React.FC = () => {
          return <Dashboard firebaseConfig={firebaseConfig} />;
      };

      const rootElement = document.getElementById('root');
      if (!rootElement) throw new Error('Root element not found');
      const root = ReactDOM.createRoot(rootElement);
      root.render(<App />);
    </script>
</body>
</html>